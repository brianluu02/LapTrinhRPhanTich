---
title: "Proposal"
author: "ƒê·ªÅ t√†i: Ph√¢n t√≠ch v√† ƒë∆∞a ra c√°c gi·∫£i ph√°p ƒë·ªÉ c·∫£i thi·ªán c√°c chi·∫øn d·ªãch marketing"
output:
  html_document:
  slidy_presentation: 
    font_adjustment: +5
  ioslides_presentation: default
  powerpoint_presentation: default
---
```{r setup, include=FALSE}
library("knitr")
knit_hooks$set(purl = hook_purl)
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

## Ph·∫ßn 1. D·ªØ li·ªáu
```{r}
library(tidyverse)
library(plyr)
library(ggplot2)
library(gridExtra)
library(cowplot)
library(dplyr)
library(Metrics)
library(caTools)
library(stargazer)
library(gghighlight)
library(ggthemes)
```

```{r}
marketing_data <- read.csv("data/marketing_data.csv", header = T)
cat("T·∫≠p d·ªØ li·ªáu g·ªìm", nrow(marketing_data),"d√≤ng v√†",ncol(marketing_data),"c·ªôt")
```

## Ph·∫ßn 2. Th·ª±c hi·ªán
### 2.1. EDA
####    2.1.1. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu
```{r}
convertIncome = function(income){
  income <- gsub('[$., ]', '', income)
  for(i in 1:length(income)){
    income[i] <- substring(income[i], 1, nchar(income[i])-2)
  }
  income <- as.integer(income)
  return(income)
}
convertToYear = function(date){
  for(i in 1:length(date)){
    if(nchar(date[i]) == 8){
      date[i] <- substring(date[i], 5, nchar(date[i]))
    }
    else if(nchar(date[i]) == 9){
      date[i] <- substring(date[i], 6, nchar(date[i]))
    }
    else{
      date[i] <- substring(date[i], 7, nchar(date[i]))
    }
  }
  date <- as.numeric(date)
  return(date)
}
marketing_data$Income <- convertIncome(marketing_data$Income)
```

####    2.1.2. X√≥a c√°c outlier, gi√° tr·ªã null
#### Bi·ªÉu ƒë·ªì th·ªÉ hi·ªán v√† c≈©ng t√¨m ra c√°c gi√° tr·ªã b·∫•t b√¨nh th∆∞·ªùng v√† ngo·∫°i l·ªá trong t·∫≠p d·ªØ li·ªáu
```{r}
df_num<-select_if(marketing_data,is.numeric)%>%select(-ID)
df_num_p<-df_num%>%gather(variable,values,1:23)
df_num_p%>%ggplot()+
  geom_boxplot(aes(x=variable,y=values), outlier.color="red") + 
  facet_wrap(~variable,ncol=5,scales="free") + 
  theme(strip.text.x = element_blank(),
        text = element_text(size=9)) 
```
##### Nh·∫≠n x√©t 
-   D·ªØ li·ªáu tr√™n cho th·∫•y c·ªôt "Income" c√≥ s·ªë thu nh·∫≠p ƒë·∫∑t bi·ªát r·∫•t cao. ƒêi·ªÅu n√†y c√≥ th·ªÉ do sai s√≥t trong qu√° tr√¨nh nh·∫≠p d·ªØ li·ªáu. Ta s·∫Ω lo·∫°i b·ªè c√°c gi√° tr·ªã ƒë√≥.
-   ƒê·ªÉ ph√¢n t√≠ch ƒë∆∞a ra c√°ch g·∫ßn ch√≠nh x√°c nh·∫•t th√¨ lo·∫°i b·ªè c√°c gi√° tr·ªã ngo·∫°i l·ªá tr√°nh l√†m ·∫£nh h∆∞·ªüng ƒë·∫øn d·ªØ li·ªáu

```{r}
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}
marketing_data$Income <- remove_outliers(marketing_data$Income)
marketing_data$MntWines <- remove_outliers(marketing_data$MntWines)
marketing_data$MntFruits <- remove_outliers(marketing_data$MntFruits)
marketing_data$MntMeatProducts <- remove_outliers(marketing_data$MntMeatProducts)
marketing_data$MntFishProducts <- remove_outliers(marketing_data$MntFishProducts)
marketing_data$MntSweetProducts <- remove_outliers(marketing_data$MntSweetProducts)
marketing_data$MntGoldProds <- remove_outliers(marketing_data$MntGoldProds)
marketing_data$NumCatalogPurchases <- remove_outliers(marketing_data$NumCatalogPurchases)
marketing_data$NumWebPurchases <- remove_outliers(marketing_data$NumWebPurchases)
```

####    2.1.3. T·∫°o c√°c c·ªôt c·∫ßn thi·∫øt
```{r}
head(marketing_data)
```
```{r}
count(marketing_data$Marital_Status)
```
- Ta c√≥ th·ªÉ k·∫øt h·ª£p Alone, Divorced, Single, Widow th√†nh 1 nh√≥m (Single), Married v√† Together th√†nh 1 nh√≥m (Coupled). Absurd v√† YOLO l√† c√°c thu·ªôc t√≠nh kh√¥ng x√°c ƒë·ªãnh
```{r}
marketing_data$Rel_Status[marketing_data$Marital_Status %in% c('Alone', 'Divorced', 'Single', 'Widow')] <- 'Single'
marketing_data$Rel_Status[marketing_data$Marital_Status %in% c('Married', 'Together')] <- 'Coupled'
marketing_data$Rel_Status[marketing_data$Marital_Status %in% c('Absurd', 'YOLO')] <- ''
```
- T·∫°o c·ªôt MntSpent t·ª´ c√°c c·ªôt MntFishProducts, MntMeatProducts, MntFruits, MntSweetProducts, MntWines, MntGoldProds. C·ªôt NumPurchases g·ªìm c√°c c·ªôt NumCatalogPurchases, NumStorePurchases, NumWebPurchases. C·ªôt TotalKid g·ªìm Kidhome, Teenhome. C·ªôt TotalAccepted g·ªìm AcceptedCmp1, AcceptedCmp2, AcceptedCmp3, AcceptedCmp4, AcceptedCmp5.
```{r}
marketing_data <- marketing_data %>% 
  mutate(MntSpent = MntFishProducts + MntMeatProducts + MntFruits + MntSweetProducts + MntWines + MntGoldProds) %>%   mutate(NumPurchases = NumCatalogPurchases + NumStorePurchases + NumWebPurchases + NumDealsPurchases) %>% 
  mutate(TotalKid = Kidhome + Teenhome) %>% 
  mutate(TotalAccepted = AcceptedCmp1 + AcceptedCmp2 + AcceptedCmp3 + AcceptedCmp4 + AcceptedCmp5) %>%
  mutate(Child = case_when (TotalKid == 0 ~ 0, TotalKid != 0 ~ 1))
```

-   Lo·∫°i b·ªè c√°c c·ªôt kh√¥ng c·∫ßn thi·∫øt v√† gi√° tr·ªã null
```{r}
uncolumn <- c('ID', 'Kidhome', 'Marital_Status', 'Teenhome', 'Year_Birth')
marketing_data <- marketing_data %>% 
  select(-one_of(uncolumn)) %>% 
  mutate_all(na_if, '') %>% 
  na.omit()
```

### 2.2. Ph√¢n t√≠ch th·ªëng k√™
#### M·ªëi quan h·ªá gi·ªØa kh√°ch h√†ng trong t·ª´ng khu v·ª±c v√† s·ª± ch·∫•p nh·∫≠n c·ªßa 1 chi·∫øn d·ªãch (chi·∫øn d·ªãch m·ªõi nh·∫•t)?
    +   Gi·∫£ thuy·∫øt nh√≥m ƒë∆∞a ra:
      ++    Ho: Kh√¥ng c√≥ m·ªëi quan h·ªá gi·ªØa kh√°ch h√†ng trong t·ª´ng khu v·ª±c v·ªõi s·ª± ch·∫≠p nh·∫≠n c·ªßa 1 chi·∫øn d·ªãch
      ++    Ha: C√≥ m·ªëi quan h·ªá gi·ªØa kh√°ch h√†ng trong t·ª´ng khu v·ª±c v·ªõi s·ª± ch·∫≠p nh·∫≠n c·ªßa 1 chi·∫øn d·ªãch
    +   ƒê·∫øm s·ªë l∆∞·ª£t ch·∫•p nh·∫≠n ho·∫∑c kh√¥ng ch·∫•p nh·∫≠n theo qu·ªëc gia
```{r}
accptByCountry <- marketing_data %>% group_by(marketing_data$Country, marketing_data$Response) %>% 
  dplyr::summarize(total_count=n(), .groups = 'drop') %>% as.data.frame()
accptByCountry
```
    +   T·∫°o ma tr·∫≠n v·ªõi s·ªë d√≤ng l√† s·ªë c√°c qu·ªëc gia, v√† c·ªôt g·ªìm 2 c·ªôt (c·ªôt ƒë·∫ßu ti√™n l√† s·ªë ng∆∞·ªùi ch·∫•p nh·∫≠n chi·∫øn d·ªãch, c·ªôt th·ª© hai l√† s·ªë ng∆∞·ªùi kh√¥ng ch·∫•p nh·∫≠n chi·∫øn d·ªãch)
    +   D√πng ki·ªÉm ƒë·ªãnh chi-squared test ƒë·ªÉ ki·ªÉm tra gi·∫£ thuy·∫øt tr√™n 
```{r}
dt_accptByCountry <- matrix(c(21, 125, 38, 226, 17, 99, 12, 134, 2, 1, 52, 283, 176, 917, 13, 94), nrow = 8, byrow = T)
dt_accptByCountry
chisq.test(dt_accptByCountry)
```
##### Nh·∫≠n x√©t
-  V·ªõi p-value = 0.06108 kh√¥ng nh·ªè h∆°n 0.05 n√™n ta kh√¥ng th·ªÉ b√°c b·ªè gi·∫£ thuy·∫øt Ho (b√°c b·ªè Ha). Ta kh√¥ng th·ªÉ k·∫øt lu·∫≠n c√≥ m·ªëi quan h·ªá gi·ªØa kh√°ch h√†ng ·ªü t·ª´ng khu v·ª±c v·ªõi v·ªõi ch·∫•p nh·∫≠n chi·∫øn d·ªãch (2 bi·∫øn ho√†n to√†n ƒë·ªôc l·∫≠p)

#### M·ªëi quan h·ªá gi·ªØa nh·ªØng ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng c√≥ con v√† s·ª± ch·∫•p nh·∫≠n chi·∫øn d·ªãch (th√†nh c√¥ng nh·∫•t) ?
    +   Gi·∫£ thuy·∫øt nh√≥m ƒë∆∞a ra:
      ++    Ho: Kh√¥ng c√≥ m·ªëi quan h·ªá gi·ªØa nh·ªØng ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng c√≥ con v√† s·ª± ch·∫•p nh·∫≠n chi·∫øn d·ªãch
      ++    Ha: C√≥ m·ªëi quan h·ªá gi·ªØa nh·ªØng ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng c√≥ con v√† s·ª± ch·∫•p nh·∫≠n chi·∫øn d·ªãch
    +   ƒê·∫øm s·ªë l∆∞·ª£t ch·∫•p nh·∫≠n ho·∫∑c kh√¥ng ch·∫•p nh·∫≠n theo nh·ªØng ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng c√≥ con
```{r}
accptByChild <- marketing_data %>% group_by(marketing_data$Child, marketing_data$AcceptedCmp4) %>% 
  dplyr::summarize(total_count=n(), .groups = 'drop') %>% as.data.frame()
accptByChild
```
    +   T·∫°o ma tr·∫≠n v·ªõi s·ªë d√≤ng l√† s·ªë ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng con, v√† c·ªôt g·ªìm 2 c·ªôt (c·ªôt ƒë·∫ßu ti√™n l√† s·ªë ng∆∞·ªùi ch·∫•p nh·∫≠n chi·∫øn d·ªãch, c·ªôt th·ª© hai l√† s·ªë ng∆∞·ªùi kh√¥ng ch·∫•p nh·∫≠n chi·∫øn d·ªãch)
    +   D√πng ki·ªÉm ƒë·ªãnh chi-squared test ƒë·ªÉ ki·ªÉm tra gi·∫£ thuy·∫øt tr√™n 
```{r}
dt_accptByChild <- matrix(c(97, 1482, 67, 564), nrow = 2, byrow = T)
dt_accptByChild
chisq.test(dt_accptByChild)
```
##### Nh·∫≠n x√©t
-   V·ªõi p-value = 0.0004075 nh·ªè h∆°n 0.0001 n√™n ta b√°c b·ªè gi·∫£ thuy·∫øt Ho (ch·∫•p nh·∫≠n Ha). Ta c√≥ th·ªÉ k·∫øt lu·∫≠n c√≥ m·ªëi quan h·ªá gi·ªØa nh·ªØng ng∆∞·ªùi c√≥ con ho·∫∑c kh√¥ng c√≥ con v√† s·ª± ch·∫•p nh·∫≠n chi·∫øn d·ªãch (2 bi·∫øn n√†y c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn nhau)

### D·ª± ƒëo√°n t·ªïng chi ti√™u c·ªßa kh√°ch h√†ng d·ª±a tr√™n thu nh·∫≠p c√° nh√¢n, s·ªë l·∫ßn mua h√†ng theo c√°c ph∆∞∆°ng th·ª©c,...
```{r}
colSums(is.na(marketing_data))
```

```{r}
data_1<- na.omit(marketing_data)
str(data_1)
```
-   Chia m√¥ h√¨nh th√†nh 2 t·∫≠p (70% train, 30% test)
```{r}
set.seed(123)
sample <- sample.split(marketing_data , SplitRatio = 0.7)
X_train <- subset(marketing_data, sample == TRUE)
X_test <- subset(marketing_data, sample == FALSE)
```
-    Hu·∫•n luy·ªán m√¥ h√¨nh
```{r}
model <- lm(X_train$MntSpent ~ .- Dt_Customer - MntGoldProds - MntSweetProducts - MntFishProducts - MntMeatProducts - MntWines - MntFruits, data = X_train)

summary(model)
```
-   C√°c bi·∫øn ·∫£nh h∆∞·ªüng ƒë·∫øn m√¥ h√¨nh
```{r}
pvaluedf <- data.frame(summary(model)$coefficients[,c('Pr(>|t|)', 'Estimate')])
colnames(pvaluedf) <- c('pvalue', 'coefficient')
pvaluedf$variables <- rownames(pvaluedf)

#Plot the variables and their significance 
pvaluedf %>% 
  ggplot(aes(x = reorder(variables, pvalue),y = pvalue)) +
    geom_col() +
    geom_hline(yintercept = 0.05, color = "white") + ## level of Significance
    geom_text(aes(x = 2, y = 0.10),label = "5%", color = "darkred") +
    scale_x_discrete(name = "Predictors") +
    ggtitle("X-Variables and their P-Values") +
    coord_flip() +
    theme_minimal()
```

-   Hu·∫•n luy·ªán m√¥ h√¨nh sau khi t√¨m ƒë∆∞·ª£c c√°c gi√° tr·ªã c√≥ ·∫£nh h∆∞·ªüng
```{r}
re_select <-select( X_train ,c('Income', 'MntSpent', 'NumWebVisitsMonth', 'NumCatalogPurchases', 'NumWebPurchases', 'NumStorePurchases'))
model1 <- lm(X_train$MntSpent ~., data = re_select)

summary(model1)
```
-   Bi·ªÉu ƒë·ªì th·ªÉ hi·ªán s∆∞ ph√¢n t√°n c·ªßa sai s·ªë
```{r}
ggplot(data=model1, aes(model1$residuals)) +
geom_histogram(binwidth = 1, color = "black", fill = "purple4") +
theme(panel.background = element_rect(fill = "white"),
axis.line.x=element_line(),
axis.line.y=element_line()) +
ggtitle("Histogram for Model Residuals")
```
-   Bi·ªÉu ƒë·ªì residuals ph√¢n b·ªë ƒë·ªÅu theo tr·ª•c 0

-   M√¥ h√¨nh h·ªìi qui tuy·∫øn t√≠nh c√≥ ph∆∞∆°ng tr√¨nh 
```{r}
stargazer(model1, type = "text")
```
-   Ph∆∞∆°ng tr√¨nh MntSpent = 0.006*Income + 20.338*NumWebVisitsMonth + 90.063*NumCatalogPurchases + 20.493*NumWebPurchases + 37.007*NumStorePurchases

-   Tr·ª±c quan h√≥a c√°c bi·∫øn ·∫£nh h∆∞·ªüng ƒë·∫øn m√¥ h√¨nh
```{r}
subset(re_select, (MntSpent < 99999999))  %>%
  ggplot(aes(Income  ,MntSpent)) +
  geom_point(alpha=0.5, size=2 , aes(color=MntSpent)) +
  geom_smooth(method='lm', formula= y~x) +
  labs(y="MntSpent", x="Income", subtitle="Icome vs MntSpent")

subset(re_select, (MntSpent < 99999999))  %>%
  ggplot(aes(NumStorePurchases  ,MntSpent)) +
  geom_point(alpha=0.5, size=2 , aes(color=MntSpent)) +
  geom_smooth(method='lm', formula= y~x) +
  labs(y="MntSpent", x="NumStorePurchases", subtitle="NumStorePurchases vs MntSpent")

subset(re_select, (MntSpent < 99999999))  %>%
  ggplot(aes(NumWebPurchases  ,MntSpent)) +
  geom_point(alpha=0.5, size=2 , aes(color=MntSpent)) +
  geom_smooth(method='lm', formula= y~x) +
  labs(y="MntSpent", x="NumWebPurchases", subtitle="NumWebPurchases vs MntSpent")
```
-   So s√°ng gi√° tr·ªã th·ª±c t·∫ø v√† gi√° tr·ªã d·ª± ƒëo√°n
```{r}
X_test$Dt_Customer <- NULL

pres<-predict(model1,X_test)
plot.default(X_test$MntSpent,type = "l",lty = 1,col="red")
lines(pres,type = "l",col = "blue")
plot.default(pres,type = "l",col="red")
```
##### Nh·∫≠n x√©t
-   Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng ·ªü tr√™n,th·ªÉ hi·ªán 2 t·∫≠p d·ªØ li·ªáu th·ª±c t·∫ø, v√† d·ª± ƒëo√°n, nh√¨n v√†o bi·ªÉu ƒë·ªì c√≥ th·ªÉ th·∫•y d·ªØ li·ªáu d·ª± ƒëo√°n c≈©ng kh√° kh·ªõp v·ªõi th·ª±c t·∫ø. Cho th·∫•y m√¥ h√¨nh d·ª± ƒëo√°n t·ªët ·ªü b·ªô d·ªØ li·ªáu test.

-   **ƒê√°nh gi√° m√¥ h√¨nh**
  +   Ta th∆∞·ªùng d√πng root-mean-square error, ùëÖùëÄùëÜùê∏ = ‚àöùëÄùëÜùê∏, v√¨ n√≥ c√≥ c√πng ƒë∆°n v·ªã v·ªõi yi(th·ª±c t·∫ø)
  +   L·ªói d·ª± ƒëo√°n RMSE (L·ªói b√¨nh ph∆∞∆°ng trung b√¨nh g·ªëc), bi·ªÉu th·ªã ch√™nh l·ªách trung b√¨nh gi·ªØa c√°c gi√° tr·ªã k·∫øt qu·∫£ ƒë√£ bi·∫øt ƒë∆∞·ª£c quan s√°t trong d·ªØ li·ªáu th·ª≠ nghi·ªám v√† c√°c gi√° tr·ªã k·∫øt qu·∫£ d·ª± ƒëo√°n c·ªßa m√¥ h√¨nh. RMSE c√†ng th·∫•p, m√¥ h√¨nh c√†ng t·ªët.
```{r}
mse<-mean((pres-X_test$MntSpent)^2)
rmse<-sqrt(mse)
sprintf("RMSE: %f", rmse)
sprintf("Chu·∫©n h√≥a RMSE: %f", rmse/(max(X_test$MntSpent) - min(X_test$MntSpent)))
sprintf("Chu·∫©n h√≥a RMSE: %f", rmse/mean(X_test$MntSpent))
sprintf("R^2 tr√™n t·∫≠p d·ª± ƒëo√°n v·ªõi t·∫≠p test: %f", cor(X_test$MntSpent,pres))
sprintf("T·∫≠p d·ªØ li·ªáu ph√¢n b·ªë t·ª´ [%d, %d]", min(X_test$MntSpent), max(X_test$MntSpent))
```
- M√¥ h√¨nh d·ª± ƒëo√°n tr√™n t·∫≠p test gi·∫£i th√≠ch ƒë∆∞·ª£c 91% s·ª± thay ƒë·ªïi c·ªßa c√°c bi·∫øn ph·ª• thu·ªôc. M·ª©c gi·∫£i th√≠ch n√†y ƒë∆∞·ª£c cho l√† kh√° t·ªët



### D·ª± ƒëo√°n kh·∫£ nƒÉng ch·∫•p nh·∫≠n chi·∫øn d·ªãch c·ªßa kh√°ch h√†ng d·ª±a v√†o l∆∞·ª£t mua h√†ng, thu nh·∫≠p, t√¨nh tr·∫°ng h√¥n nh√¢n, s·ªë con trong gia ƒë√¨nh, ...
- lo·∫°i b·ªè c√°c gi√° tr·ªã NA
```{r}
data_1<- na.omit(marketing_data)
str(data_1)
```

**B∆∞·ªõc 1 S·ª≠ d·ª•ng h·ªìi quy logistic**
- Tham s·ªë ƒë·∫ßu v√†o: C√°c thu·ªôc t√≠nh c·ªßa d·ªØ li·ªáu

- Tham s·ªë d·ª± ƒëo√°n: Ph·∫£n h·ªìi (kh·∫£ nƒÉng ch·∫•p nh·∫≠n chi·∫øn d·ªãch)

- Ph∆∞∆°ng ph√°p: glm cho m√¥ h√¨nh logistic

- Ph∆∞∆°ng ph√°p ƒë√°nh gi√°: ma tr·∫≠n nh·∫ßm l·∫´n

-   Chia m√¥ h√¨nh th√†nh 2 t·∫≠p (70% train, 30% test)
```{r}
library(caTools)
set.seed(123)
sample <- sample.split(marketing_data$Response , SplitRatio = 0.7)

# chia m·∫´u th√†nh X_train,X_test

X_train <- subset(marketing_data, sample == TRUE)# m·∫´u x√¢y d·ª±ng 
X_test <- subset(marketing_data, sample == FALSE)# m·∫´u ki·ªÉm ƒë·ªãnh

X_train$Response <- as.integer(X_train$Response)
X_test$Response <- as.integer(X_test$Response)

```
- X√¢y d·ª±ng h·ªìi quy logistic
```{r}

model4 <- glm(formula = Response ~ Income+Education+Recency+MntWines+MntFruits+MntMeatProducts+MntFishProducts+MntSweetProducts+MntGoldProds+NumDealsPurchases+NumWebPurchases+NumCatalogPurchases+NumStorePurchases+NumWebVisitsMonth ,family = "binomial" ,data = X_train)
summary(model4)
#glmImp <- varImp(model4)
#family = "binomial" bi·∫øn nh·ªã ph√¢n c≈©ng l√† bi·∫øn k·∫øt qu·∫£ 

```
- Theo quan s√°t m√¥ h√¨nh, c√°c bi·∫øn ·∫£nh h∆∞·ªüng ƒë·∫øn chi·∫øn d·ªãch l√†: NumWebVisitsMonth NumStorePurchases,MntMeatProducts, MntGoldProds, MntWines,Recency

**ƒê∆∞a ra d·ª± ƒëo√°n v·ªõi 'Response' l√† x√°c su·∫•t**

```{r}
# ƒë∆∞a ra d·ª± ƒëo√°n v·ªõi response l√† x√°c xu·∫•t 
probabilities = predict(model4,X_test, type = "response")
# v·ªõi x√°c xu·∫•t n·∫±m trong kho·∫£ng th√¨ ƒë√°nh gi√° m√¥ h√¨nh v·ªõi ƒë·ªô ch√≠nh x√°c m√¥ h√¨nh 
predicted.classes <- ifelse(probabilities > 0.5, 1, 0)
mean(predicted.classes == X_test$Response)
```
- V·ªõi d·ª± ƒëo√°n x√°c xu·∫•t l√† 89% ƒë·ªô ch√≠nh x√°c m√¥ h√¨nh kh√° cao 
**B∆∞·ªõc 2 x√¢y d·ª±ng ma tr·∫≠n nh·∫ßn l·∫´n**
- x√¢y d·ª±ng m·ªôt ma tr·∫≠n ƒë·ªÉ so s√°nh c√°c gi√° tr·ªã th·ª±c t·∫ø v√† d·ª± ƒëo√°n
```{r} 
table(X_test$Response, predicted.classes > 0.5 )
```
- T√≠nh ƒë·ªô nh·∫°y 
```{r}
20/(79+20)
```
- ƒê·ªô nh·∫°y : Trong chi·∫øn d·ªãch th·ª±c t·∫ø th√†nh c√¥ng c√≥ 20% ƒë∆∞·ª£c d·ª± b√°o th√†nh c√¥ng 

- T√≠nh ƒë·ªô ƒë·∫∑c hi·ªáu 
```{r}
545/(79+545)
```
- ƒê·ªô ƒë·ªô ƒë·∫∑c hi·ªáu : Trong chi·∫øn d·ªãch th·ª±c t·∫ø kh√¥ng th√†nh c√¥ng c√≥ 87% ƒë∆∞·ª£c d·ª± b√°o kh√¥ng th√†nh c√¥ng
                                                                                                                                  

-ƒê·ªô ch√≠nh x√°c cao 87% tuy nhi√™n d·ªô nh·∫°y kh√° th·∫•p v·ªõi 20%: Kh√¥ng d·ª± b√°o ƒë∆∞·ª£c chi·∫øn d·ªãch th·ª±c t·∫ø th√†nh c√¥ng 


- X√¢y d·ª±ng ph∆∞∆°ng tr√¨nh d·ª± b√°o
```{r}

library(ROCR)
# ph∆∞∆°ng tr√¨nh d·ª± b√°o 
ptdubao = prediction(probabilities ,X_test$Response)
# x√¢y d·ª±ng h√†m th·ª±c hi·ªán v·ªõi ƒë·ªô nh·∫°y v√† ƒë·ªô ƒë·∫∑c hi·ªáu
hinhptdubao  = performance(ptdubao , "tpr", "fpr")
plot(hinhptdubao)
#plot(hinhptdubao , colorize = TRUE, print.cotoffs.at  = seq (0,1, by=0.1 ),test.adj= c(-0.2,1.7))


```

- ƒê∆∞·ªùng cong bi·ªÉu di·ªÖn m·ª©c ng∆∞·ª°ng t ph·ª• thu·ªôc v√†o sai s·ªë trong m√¥ h√¨nh
- Khi ƒë·ªô nh·∫°y tƒÉng th√¨ sai s·ªë d∆∞∆°ng gi·∫£ tƒÉng v√† ng∆∞·ª£c l·∫°i

-Ch·ªâ s·ªë ƒë∆∞·ªùng AUROC


```{r}
as.numeric(performance(ptdubao, "auc")@y.values)
```
- Ch·ªâ b√°o ƒë∆∞·ªùng cong AUC th·ªÉ hi·ªán kh·∫£ nƒÉng d·ª± ƒëo√°n c·ªßa m√¥ h√¨nh v·ªõi t·ª∑ l·ªá th√†nh c√¥ng l√† 83.74%, cho th·∫•y m√¥ h√¨nh d·ª± ƒëo√°n kh√° t·ªët c·∫£ v·ªÅ √¢m t√≠nh th·ª±c v√† d∆∞∆°ng t√≠nh th·ª±c.

### 2.3. Tr·ª±c quan h√≥a d·ªØ li·ªáu
##### T·ª∑ l·ªá ch·∫•p nh·∫≠n c√°c chi·∫øn d·ªãch ti·∫øp th·ªã theo t·ª´ng khu v·ª•c ?
```{r}
df_campaigns<-marketing_data%>%
  select(Country,AcceptedCmp1,AcceptedCmp2,AcceptedCmp3,AcceptedCmp4,AcceptedCmp5)%>%
  group_by(Country)%>%
  summarise_all(funs(mean))%>%
  gather(.,Campaign,Acceptance_rate,"AcceptedCmp1":"AcceptedCmp5")

ggplot(data =df_campaigns ,aes(x=Country,y=Acceptance_rate,fill=Campaign))+
  geom_col(position="stack",width=0.5)+
  scale_fill_brewer(palette = "RdGy")+
  scale_y_continuous(labels=scales::percent)+
  ggtitle("Acceptance rate of Campaigns across Countries") 
```
##### Nh·∫≠n x√©t 
- T·ª´ bi·ªÉu ƒë·ªì tr√™n,ta c√≥ th·ªÉ th·∫•y r·∫±ng t·ª∑ l·ªá ch·∫•p nh·∫≠n c·ªßa c√°c chi·∫øn d·ªãch 1,3,4,5 tr√™n kh·∫Øp t·∫•t c·∫£ c√°c qu·ªëc gia g·∫ßn g·∫ßn gi·ªëng nhau (ngo·∫°i tr·ª´ qu·ªëc gia ME) 
- C√≥ 3 v√πng "AUS", "ME", "US" ch∆∞a ch·∫•p nh·∫≠n chi·∫øn dich s·ªë 2 ta n√™n ƒë·ªÅ xu·∫•t chi·∫øn d·ªãch t∆∞∆°ng ·ª©ng ƒë·ªÉ tƒÉng t·ªâ l·ªá ch·∫•p nh·∫≠n tr√™n c√°c qu·ªëc gia 
##### Ph∆∞∆°ng th·ª©c b√°n h√†ng n√†o k√©m hi·ªáu qu·∫£ nh·∫•t ?
```{r}
s <- c(sum(marketing_data$NumDealsPurchases), sum(marketing_data$NumCatalogPurchases), sum(marketing_data$NumStorePurchases), sum(marketing_data$NumWebPurchases))
s <- round((s/sum(marketing_data$NumPurchases))*100)
label <- c("Deal", "Catalog", "Store", "Web")
data <- data.frame(label, s)
ggplot(data, aes(x="", y=s, fill=label)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  geom_text(aes(label = paste0(s, "%")), position = position_stack(vjust=0.5)) +
  labs(x = NULL, y = NULL, fill = NULL) +
  theme_classic() +
  theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
  scale_fill_manual(values=c("#6BAE6A", "#FDE82E", "#4B0B5B", "#34667E"))
```
##### Nh·∫≠n x√©t
- T·ª´ bi·ªÉu ƒë·ªì tr√™n,ta c√≥ th·ªÉ th·∫•y r·∫±ng s·ªë l·∫ßn mua h√†ng tr·ª±c ti·∫øp t·∫°i c·ª≠a h√†ng v√† mua tr·ª±c tuy·∫øn chi·∫øm t·ª∑ l·ªá cao. Trong ƒë√≥ mua h√†ng t·∫°i c·ª≠a h√†ng ƒë∆∞·ª£c ∆∞a chu·ªông
- S·ªë l·∫ßn mua h√†ng theo danh m·ª•c v√† s·ªë l·∫ßn mua h√†ng ƒë∆∞·ª£c gi·∫£m gi√° c√≤n kh√° th·∫•p. Do ƒë√≥ c·∫ßn ph·∫£i ƒë∆∞a ra c√°c chi·∫øn l∆∞·ª£c qu·∫£ng c√°o tr√™n truy·ªÅn th√¥ng ƒë·ªÉ thu h√∫t s·ª± ch√∫ √Ω c·ªßa nhi·ªÅu kh√°ch h√†ng h∆°n
##### S·∫£n ph·∫©m n√†o chi·∫øm doanh thu nhi·ªÅu nh·∫•t ?
```{r}
products <- c("Wines", "Fruits", "Meat", "Fish", "Sweets", "Gold")
spent <- c(sum(marketing_data$MntWines), sum(marketing_data$MntFruits), sum(marketing_data$MntMeatProducts), sum(marketing_data$MntFishProducts), sum(marketing_data$MntSweetProducts), sum(marketing_data$MntGoldProds))

df <- data.frame(products, spent)
ggplot(df, aes(x="", y=spent, fill=products)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  geom_text(aes(label = paste0(spent, "$")), position = position_stack(vjust=0.5)) +
  labs(x = NULL, y = NULL, fill = NULL) +
  theme_classic() +
  theme(axis.line = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank()) +
  scale_fill_manual(values=c("#7CB5EC", "#434348", "#90ED7D", "#F7A35C", "#8085E9", "#F15C80"))
```
##### Nh·∫≠n x√©t
- C√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c r∆∞·ª£u l√† m·∫∑t h√†ng b√°n kh√° ch·∫°y. Tr√°i c√¢y v√† ƒë·ªì ng·ªçt ƒë∆∞·ª£c √≠t ng∆∞·ªùi ti√™u d√πng ch√∫ √Ω nhi·ªÅu
##### Chi·∫øn d·ªãch th√†nh c√¥ng nh·∫•t v√† k√©m nh·∫•t ?
```{r}
df_cam<-marketing_data%>%
    group_by(Rel_Status) %>% 
    pivot_longer(contains("cmp")) %>% 
    mutate(name=case_when(
      name == "accepted_cmp1" ~ "Cmp_1",
      name == "accepted_cmp2" ~ "Cmp_2",
      name == "accepted_cmp4" ~ "Cmp_4",
      name == "accepted_cmp5" ~ "Cmp_5",
      name == "accepted_cmp3"~ "Cmp_3",
      TRUE ~ name))->cmp_pivot
aggregate(value ~Rel_Status+name,cmp_pivot,sum)->agg_cmp  

agg_cmp %>% 
  group_by(name) %>% 
  ggplot(aes(name,value))+geom_col(fill="blue")+
  gghighlight::gghighlight(name=="Cmp_4")+
labs(title = "Each Of The Campaigns Did Well Apart From Campaign 2",
     subtitle = "Campaign 3, 4 did better than any other camapaign",
     y="COunt of Campaign",x="Campaign")+
  ggthemes::theme_igray()
```
##### Nh·∫≠n x√©t
 - Chi·∫øn d·ªãch 3, 4 t·ªët h∆°n c√°c chi·∫øn d·ªãch c√≤n l·∫°i
 - Chi·∫øn d·ªãch 2 l√† chi·∫øn d·ªãch t·∫ø nh·∫•t
 
### 2.4. Nh·∫≠n x√©t v√† ƒë·ªÅ xu·∫•t c√°c bi·ªán ph√°p
 - C√°c s·∫£n ph·∫©m th√†nh c√¥ng nh·∫•t l√† r∆∞·ª£u vang v√† th·ªãt (t·ª©c l√† kh√°ch h√†ng trung b√¨nh ƒë√£ chi ti√™u nhi·ªÅu nh·∫•t cho c√°c m·∫∑t h√†ng n√†y) .ƒê·ªÅ xu·∫•t: t·∫≠p trung c√°c chi·∫øn d·ªãch qu·∫£ng c√°o ƒë·ªÉ tƒÉng doanh s·ªë c·ªßa c√°c m·∫∑t h√†ng √≠t ph·ªï bi·∫øn h∆°n). 
 - Chi·∫øn d·ªãch 2 l√† chi·∫øn d·ªãch k√©m hi·ªáu qu·∫£ ·ªü m·ªçi khu v·ª±c ƒë∆∞·ª£c √°p d·ª•ng. C√≥ th·ªÉ lo·∫°i b·ªè chi·∫øn d·ªãch 2 ho·∫∑c √°p d·ª•ng c√°c m√¥ h√¨nh c·ªßa chi·∫øn d·ªãch 3,4 sang chi·∫øn d·ªãch 2
 - Ph∆∞∆°ng th·ª©c b√°n h√†ng h√†ng ƒë·∫ßu l√† tr·ª±c ti·∫øp t·∫°i c·ª≠a h√†ng, theo sau l√† b√°n h√†ng qua trang web.
 - Khuy·∫øn kh√≠ch t·∫≠p trung qu·∫£ng c√°o c√°c chi·∫øn d·ªãch trong c√°c ph∆∞∆°ng th·ª©c b√°n h√†ng th√†nh c√¥ng h∆°n ƒë·ªÉ ti·∫øp c·∫≠n nhi·ªÅu kh√°ch h√†ng h∆°n v√† c≈©ng ƒë·ªÉ tƒÉng doanh s·ªë c·ªßa c√°c s·∫£n ph·∫©m ho·∫°t ƒë·ªông k√©m.
 - Kh√°ch h√†ng th∆∞·ªùng xuy√™n l√† nh·ªØng ng∆∞·ªùi mua s·∫£n ph·∫©m th√¥ng qua c·∫£ ba ph∆∞∆°ng th·ª©c. Nh∆∞ ƒë√£ n√™u tr∆∞·ªõc ƒë√¢y, mua h√†ng Web & Catalog c√≥ t√°c ƒë·ªông t√≠ch c·ª±c ƒë·∫øn vi·ªác mua ·ªü c·ª≠a h√†ng. ƒê·ªÅ xu·∫•t ra m·ªôt h·ªá th·ªëng ph·∫ßn th∆∞·ªüng duy nh·∫•t cho ph∆∞∆°ng th·ª©c c·ª≠a h√†ng s·∫Ω tƒÉng c∆∞·ªùng s·ª± tham gia c·ªßa ng∆∞·ªùi ti√™u d√πng v√† d·ª± ki·∫øn v√† s·∫Ω tƒÉng s·ªë l∆∞·ª£ng giao d·ªãch mua ·ªü c·ª≠a h√†ng